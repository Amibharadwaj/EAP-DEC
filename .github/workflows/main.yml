name: Sync with Upstream Repository

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight UTC
  workflow_dispatch:  # Allows manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/eng-accelerator/ai-accelerator-C3.git || true
          git fetch upstream 

      - name: Check for updates
        id: check_updates
        run: |
          COUNT=$(git rev-list --count HEAD..upstream/main 2>/dev/null || echo 0)
          echo "upstream_changes=$COUNT" >> $GITHUB_OUTPUT
          git log --oneline HEAD..upstream/main > /tmp/upstream_changes.txt 2>/dev/null || echo "No changes" > /tmp/upstream_changes.txt
          cat /tmp/upstream_changes.txt

      - name: Merge upstream changes
        if: steps.check_updates.outputs.upstream_changes > 0
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git merge upstream/main -m "Sync: Merge upstream changes from ai-accelerator-C3" || true

      - name: Push changes
        if: steps.check_updates.outputs.upstream_changes > 0
        run: |
          git push origin main

      - name: Create notification for sync success
        if: steps.check_updates.outputs.upstream_changes > 0
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const changes = fs.existsSync('/tmp/upstream_changes.txt')
              ? fs.readFileSync('/tmp/upstream_changes.txt', 'utf8')
              : 'No detailed changes available';

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Repository Synced with Upstream',
              body: `## Sync Notification\n\nRepository synchronized with upstream ai-accelerator-C3\n\n**Changes detected:** ${{ steps.check_updates.outputs.upstream_changes }}\n\n**Recent commits:**\n\`\`\`\n${changes}\n\`\`\`\n\nPlease review the merged changes.`,
              labels: ['sync', 'automated']
            });

      - name: No changes notification
        if: steps.check_updates.outputs.upstream_changes == 0
        run: |
          echo "Repository is already in sync with upstream repository."
          echo "No changes detected from upstream."
